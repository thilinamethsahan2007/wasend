<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaSender Personal Bot</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bs-body-bg: #0f172a;
            --bs-body-color: #e2e8f0;
            --bs-border-color: rgba(255, 255, 255, 0.15);
            --bs-emphasis-color: #f8fafc;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--bs-border-color);
        }
        .form-control, .form-select {
            background-color: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: var(--bs-body-color);
        }
        .form-control:focus, .form-select:focus {
            background-color: rgba(255, 255, 255, 0.12);
            border-color: #3b82f6;
            color: var(--bs-body-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .modal-content {
            background: #1e293b;
        }
        .btn-primary {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .status-connected { color: #10b981; }
        .status-disconnected { color: #ef4444; }
        .status-connecting { color: #f59e0b; }
        .toast-container {
            z-index: 1100;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <a href="/" class="d-flex align-items-center text-white text-decoration-none">
                <i class="bi bi-robot fs-2 me-2"></i>
                <span class="fs-4">WaSender Personal Bot</span>
            </a>
        </header>

        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title"><i class="bi bi-power me-2"></i>Bot Control</h5>
                        <div id="connectionStatus" class="fs-5 mb-3 status-disconnected">ðŸ”´ Disconnected</div>
                        <div id="qrCode" class="mb-3"></div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="connectBtn"><i class="bi bi-play-fill me-1"></i>Connect</button>
                            <button class="btn btn-danger" id="disconnectBtn"><i class="bi bi-stop-fill me-1"></i>Disconnect</button>
                        </div>
                        <hr>
                        <div class="text-start">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" role="switch" id="autoViewStatus">
                                <label class="form-check-label" for="autoViewStatus">Auto-view Status</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" role="switch" id="autoReactStatus">
                                <label class="form-check-label" for="autoReactStatus">Auto-react to Status</label>
                            </div>
                            <div class="mb-2">
                                <label for="reactionEmoji" class="form-label">Reaction Emojis</label>
                                <input type="text" class="form-control" id="reactionEmoji" placeholder="e.g., ðŸ”¥,ðŸ‘,ðŸ˜‚">
                            </div>
                             <button class="btn btn-sm btn-primary" id="saveSettingsBtn">Save Settings</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-send me-2"></i>Send Message</h5>
                        <div class="mb-3">
                            <label for="recipients" class="form-label">Recipients</label>
                            <div class="input-group">
                                <textarea id="recipients" class="form-control" placeholder="Enter phone numbers, comma-separated"></textarea>
                                <button class="btn btn-outline-secondary" type="button" id="browseContactsBtn"><i class="bi bi-people"></i></button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="caption" class="form-label">Message</label>
                                <textarea id="caption" class="form-control" placeholder="Type your message..."></textarea>
                                <div id="smartReplies" class="mt-2"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="mediaFile" class="form-label">Media (Optional)</label>
                                <input type="file" id="mediaFile" class="form-control">
                            </div>
                        </div>
                        <div class="row align-items-end">
                            <div class="col-md-6 mb-3">
                                <label for="sendAt" class="form-label">Schedule (Optional)</label>
                                <input type="datetime-local" id="sendAt" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3 d-grid">
                                <button class="btn btn-primary" id="scheduleBtn"><i class="bi bi-clock-history me-1"></i>Send / Schedule</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-person-lines-fill me-2"></i>Contacts</h5>
                        <div class="input-group mb-3">
                            <input type="file" id="vcfImportFile" class="form-control" accept=".vcf">
                            <button class="btn btn-outline-secondary" id="importVcfBtn" type="button">Import VCF</button>
                            <a href="/api/contacts/export-csv" class="btn btn-outline-secondary" download="contacts.csv">Export to CSV</a>
                        </div>
                        <div id="contactList" class="list-group" style="max-height: 180px; overflow-y: auto;">
                            <!-- Contacts will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-cake2 me-2"></i>Birthday Reminders</h5>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6"><input type="text" id="birthdayName" class="form-control" placeholder="Name"></div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" id="birthdayPhone" class="form-control" placeholder="Phone">
                                    <button class="btn btn-outline-secondary" type="button" id="browseBirthdayContactBtn"><i class="bi bi-people"></i></button>
                                </div>
                            </div>
                            <div class="col-md-6"><input type="date" id="birthdayDate" class="form-control"></div>
                            <div class="col-md-6">
                                <select id="birthdayGender" class="form-select">
                                    <option selected disabled>Gender...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <select id="birthdayRelationship" class="form-select">
                                    <option selected disabled>Relationship...</option>
                                    <option value="friend">Friend</option>
                                    <option value="family">Family</option>
                                    <option value="relative">Relative</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <input type="text" id="birthdayCustomMessage" class="form-control" placeholder="Optional: Custom Message">
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-outline-secondary" id="previewBirthdayMsgBtn" type="button">Preview AI</button>
                            <button class="btn btn-primary" id="addBirthdayBtn" type="button">Add Birthday</button>
                        </div>
                         <div id="birthdayList" class="list-group mt-3" style="max-height: 300px; overflow-y: auto;">
                            <!-- Birthdays will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
         <div class="row">
            <div class="col-12 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-card-list me-2"></i>Message Queue</h5>
                        <div id="queueList" style="max-height: 300px; overflow-y: auto;"></div>
                         <button class="btn btn-sm btn-outline-danger mt-3" id="clearQueueBtn">Clear Finished</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contacts Modal -->
    <div class="modal fade" id="contactsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Contacts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="contactSearchInput" class="form-control mb-3" placeholder="Search contacts...">
                    <div id="modalContactList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addSelectedContactsBtn">Add Selected</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        const contactsModal = new bootstrap.Modal(document.getElementById('contactsModal'));

        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>`;
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastEl = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        // Socket listeners
        socket.on('connection:init', (data) => {
            updateConnectionStatus(data.status.connected, data.isConnecting);
            document.getElementById('queueSize').textContent = data.queueSize;
        });

        socket.on('connection:update', (data) => {
            updateConnectionStatus(data.connected, data.isConnecting);
             if(data.reason) showToast(`Disconnected: ${data.reason}`, 'warning');
        });

        socket.on('qr', (data) => {
            document.getElementById('qrCode').innerHTML = `<img src="${data.qr}" class="img-fluid rounded">`;
        });
        
        socket.on('queue:update', (data) => {
            loadQueue();
        });

        socket.on('queue:scheduled', (newItems) => {
            const listEl = document.getElementById('queueList');
            const emptyEl = listEl.querySelector('p');
            if (emptyEl) {
                emptyEl.remove();
            }
            newItems.forEach(item => {
                const itemHTML = `<div class="list-group-item list-group-item-action bg-transparent text-white">
                    <div>To: ${item.Recipient} - Status: <span class="badge bg-warning">pending</span></div>
                    <small class="text-muted">${item.Caption ? item.Caption.substring(0,50)+'...' : '[Media]'}</small>
                </div>`;
                listEl.insertAdjacentHTML('afterbegin', itemHTML);
            });
        });

        socket.on('ai:reply-suggestions', (data) => {
            const smartRepliesEl = document.getElementById('smartReplies');
            smartRepliesEl.innerHTML = '';
            if (data.suggestions && data.suggestions.length > 0) {
                data.suggestions.forEach(suggestion => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-outline-primary me-2 mb-2';
                    btn.textContent = suggestion;
                    btn.onclick = () => {
                        const captionEl = document.getElementById('caption');
                        captionEl.value += (captionEl.value ? ' ' : '') + suggestion;
                    };
                    smartRepliesEl.appendChild(btn);
                });
            }
        });

        function updateConnectionStatus(connected, connecting) {
            const statusEl = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const qrCodeEl = document.getElementById('qrCode');

            connectBtn.disabled = connected || connecting;
            disconnectBtn.disabled = !connected;

            if (connected) {
                statusEl.className = 'fs-5 mb-3 status-connected';
                statusEl.innerHTML = 'ðŸŸ¢ Connected';
                qrCodeEl.innerHTML = '';
            } else if (connecting) {
                statusEl.className = 'fs-5 mb-3 status-connecting';
                statusEl.innerHTML = 'ðŸŸ¡ Connecting...';
            } else {
                statusEl.className = 'fs-5 mb-3 status-disconnected';
                statusEl.innerHTML = 'ðŸ”´ Disconnected';
                qrCodeEl.innerHTML = '';
            }
        }

        // Bot controls
        document.getElementById('connectBtn').addEventListener('click', () => {
            fetch('/api/bot/connect', { method: 'POST' });
            showToast('Connecting...', 'info');
        });

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            fetch('/api/bot/disconnect', { method: 'POST' });
            showToast('Disconnecting...', 'info');
        });

        // Message Scheduling
        document.getElementById('scheduleBtn').addEventListener('click', async () => {
            const formData = new FormData();
            formData.append('recipients', document.getElementById('recipients').value);
            formData.append('caption', document.getElementById('caption').value);
            formData.append('sendAt', document.getElementById('sendAt').value);
            if (document.getElementById('mediaFile').files[0]) {
                formData.append('media', document.getElementById('mediaFile').files[0]);
            }

            const response = await fetch('/api/schedule', { method: 'POST', body: formData });
            const result = await response.json();
            if (result.success) {
                showToast(result.message, 'success');
                document.getElementById('recipients').value = '';
                document.getElementById('caption').value = '';
                document.getElementById('mediaFile').value = '';
            } else {
                showToast(`Error: ${result.error}`, 'danger');
            }
        });
        
        // VCF Import
        document.getElementById('importVcfBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('vcfImportFile');
            if (!fileInput.files[0]) {
                return showToast('Please select a VCF file.', 'warning');
            }
            const formData = new FormData();
            formData.append('vcf', fileInput.files[0]);
            
            const btn = document.getElementById('importVcfBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Importing...';

            const response = await fetch('/api/contacts/import-vcf', { method: 'POST', body: formData });
            const result = await response.json();
            
            if (response.ok) {
                showToast(result.message, 'success');
                loadContacts();
            } else {
                showToast(`Error: ${result.error}`, 'danger');
            }
            btn.disabled = false;
            btn.innerHTML = 'Import VCF';
        });

        // Birthday Management
        document.getElementById('addBirthdayBtn').addEventListener('click', async () => {
            const name = document.getElementById('birthdayName').value;
            const phone = document.getElementById('birthdayPhone').value;
            const birthday = document.getElementById('birthdayDate').value;
            const gender = document.getElementById('birthdayGender').value;
            const relationship = document.getElementById('birthdayRelationship').value;
            const customMessage = document.getElementById('birthdayCustomMessage').value;

            if (!name || !phone || !birthday || gender === 'Gender...' || relationship === 'Relationship...') {
                return showToast('Please fill all birthday fields.', 'warning');
            }

            const response = await fetch('/api/birthdays', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, phone, birthday, gender, relationship, customMessage })
            });
            const result = await response.json();
            if (result.success) {
                showToast('Birthday added!', 'success');
                loadBirthdays();
                document.getElementById('birthdayName').value = '';
                document.getElementById('birthdayPhone').value = '';
                document.getElementById('birthdayDate').value = '';
                document.getElementById('birthdayGender').selectedIndex = 0;
                document.getElementById('birthdayRelationship').selectedIndex = 0;
                document.getElementById('birthdayCustomMessage').value = '';
            } else {
                showToast(`Error: ${result.error}`, 'danger');
            }
        });

        document.getElementById('previewBirthdayMsgBtn').addEventListener('click', async () => {
            const name = document.getElementById('birthdayName').value;
            const gender = document.getElementById('birthdayGender').value;
            const relationship = document.getElementById('birthdayRelationship').value;

            if (!name || gender === 'Gender...' || relationship === 'Relationship...') {
                return showToast('Please provide Name, Gender, and Relationship for a preview.', 'warning');
            }

            const btn = document.getElementById('previewBirthdayMsgBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                const response = await fetch('/api/birthdays/preview-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, gender, relationship })
                });
                const result = await response.json();
                if (result.success) {
                    showToast(`Preview: "${result.message}"`, 'info');
                } else {
                    showToast(`Error: ${result.error}`, 'danger');
                }
            } finally {
                btn.disabled = false;
                btn.innerText = 'Preview AI';
            }
        });

        // Contact Modal
        let contactModalTarget = null; // 'recipients' or 'birthday'

        async function openContactsModal(target) {
            contactModalTarget = target;
            contactsModal.show();
            const listEl = document.getElementById('modalContactList');
            listEl.innerHTML = 'Loading...';
            const response = await fetch('/api/contacts');
            const contacts = await response.json();
            
            let contactsHTML = '';
            if(contacts.length > 0) {
                contacts.forEach(c => {
                    contactsHTML += `<div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${c.phone}" id="contact-${c.id}" data-name="${c.name}">
                        <label class="form-check-label" for="contact-${c.id}">${c.name} (${c.phone})</label>
                    </div>`;
                });
            } else {
                contactsHTML = '<p class="text-muted">No contacts found.</p>';
            }
            listEl.innerHTML = contactsHTML;
        }

        document.getElementById('browseContactsBtn').addEventListener('click', () => openContactsModal('recipients'));
        document.getElementById('browseBirthdayContactBtn').addEventListener('click', () => openContactsModal('birthday'));

        document.getElementById('addSelectedContactsBtn').addEventListener('click', () => {
            const selectedCheckboxes = Array.from(document.querySelectorAll('#modalContactList .form-check-input:checked'));
            
            if (contactModalTarget === 'recipients') {
                const selectedPhones = selectedCheckboxes.map(el => el.value);
                const recipientsEl = document.getElementById('recipients');
                const existing = recipientsEl.value ? recipientsEl.value.split(',').map(s => s.trim()).filter(s => s) : [];
                const newRecipients = [...new Set([...existing, ...selectedPhones])];
                recipientsEl.value = newRecipients.join(', ');
            } else if (contactModalTarget === 'birthday') {
                if (selectedCheckboxes.length > 0) {
                    const firstSelected = selectedCheckboxes[0];
                    document.getElementById('birthdayName').value = firstSelected.getAttribute('data-name');
                    document.getElementById('birthdayPhone').value = firstSelected.value;
                }
            }
            
            contactsModal.hide();
        });

        document.getElementById('contactSearchInput').addEventListener('keyup', () => {
            const searchTerm = document.getElementById('contactSearchInput').value.toLowerCase();
            const contacts = document.querySelectorAll('#modalContactList .form-check');
            contacts.forEach(contact => {
                const label = contact.querySelector('label');
                if (label.textContent.toLowerCase().includes(searchTerm)) {
                    contact.style.display = '';
                } else {
                    contact.style.display = 'none';
                }
            });
        });

        // Data Loading Functions
        async function loadContacts() {
            const response = await fetch('/api/contacts');
            const contacts = await response.json();
            const listEl = document.getElementById('contactList');
            if (contacts.length > 0) {
                listEl.innerHTML = contacts.map(c => `<div class="list-group-item list-group-item-action bg-transparent text-white">${c.name} <small class="text-muted">(${c.phone})</small></div>`).join('');
            } else {
                listEl.innerHTML = '<p class="text-center text-muted p-3">No contacts yet.</p>';
            }
        }

        async function loadBirthdays() {
            const response = await fetch('/api/birthdays');
            const birthdays = await response.json();
            const listEl = document.getElementById('birthdayList');
            if (birthdays.length > 0) {
                listEl.innerHTML = birthdays.map(b => `<div class="list-group-item list-group-item-action bg-transparent text-white d-flex justify-content-between align-items-center">
                    <div>${b.name} <small class="text-muted">(${new Date(b.birthday).toLocaleDateString()})</small></div>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBirthday('${b.id}')"><i class="bi bi-trash"></i></button>
                </div>`).join('');
            } else {
                listEl.innerHTML = '<p class="text-center text-muted p-3">No birthdays added.</p>';
            }
        }
        
        async function deleteBirthday(id) {
            if (!confirm('Are you sure?')) return;
            await fetch(`/api/birthdays/${id}`, { method: 'DELETE' });
            showToast('Birthday deleted.', 'success');
            loadBirthdays();
        }

        async function loadQueue() {
            const response = await fetch('/api/schedule');
            const queue = await response.json();
            const listEl = document.getElementById('queueList');
            if (queue.length > 0) {
                listEl.innerHTML = queue.map(item => `<div class="list-group-item list-group-item-action bg-transparent text-white">
                    <div>To: ${item.recipient} - Status: <span class="badge bg-${item.status === 'pending' ? 'warning' : (item.status === 'sent' ? 'success' : 'danger')}">${item.status}</span></div>
                    <small class="text-muted">${item.caption ? item.caption.substring(0,50)+'...' : '[Media]'}</small>
                </div>`).join('');
            } else {
                listEl.innerHTML = '<p class="text-center text-muted p-3">Queue is empty.</p>';
            }
        }
        
        document.getElementById('clearQueueBtn').addEventListener('click', async () => {
            if (!confirm('Clear sent/failed messages?')) return;
            await fetch('/api/schedule/clear', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({mode: 'all'}) });
            showToast('Queue cleared.', 'success');
            loadQueue();
        });

        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            loadContacts();
            loadBirthdays();
            loadQueue();
            loadSettings();
        });

        async function loadSettings() {
            const response = await fetch('/api/settings');
            const settings = await response.json();
            document.getElementById('autoViewStatus').checked = settings.autoViewStatus;
            document.getElementById('autoReactStatus').checked = settings.autoReactStatus;
            document.getElementById('reactionEmoji').value = settings.reactionEmoji;
        }

        document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
            const settings = {
                autoViewStatus: document.getElementById('autoViewStatus').checked,
                autoReactStatus: document.getElementById('autoReactStatus').checked,
                reactionEmoji: document.getElementById('reactionEmoji').value,
            };
            const response = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            const result = await response.json();
            if (result.success) {
                showToast('Settings saved!', 'success');
            } else {
                showToast('Failed to save settings.', 'danger');
            }
        });
    </script>
</body>
</html>